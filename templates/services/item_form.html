{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} | {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .makes-input-container {
        margin-top: 1rem;
    }
    .make-tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem;
        font-size: 0.875rem;
    }
    .make-tag .remove-make {
        margin-left: 0.5rem;
        cursor: pointer;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">{{ title }}</h3>
            </div>
            <div class="card-body">
                <form method="post" id="item-form">
                    {% csrf_token %}
                    <div class="form-group">
                        {{ form.service|as_crispy_field }}
                    </div>
                    <div class="form-group">
                        {{ form.name|as_crispy_field }}
                    </div>
                    <div class="form-group makes-input-container">
                        <label for="id_makes">Makes</label>
                        <div class="input-group">
                            <input type="text" id="make-input" class="form-control" placeholder="Enter a make name">
                            <div class="input-group-append">
                                <button type="button" class="btn btn-success" id="add-make">Add Make</button>
                            </div>
                        </div>
                        <div id="makes-display" class="mt-2"></div>
                        {{ form.makes }}
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <a href="{% url 'item_list' service.pk %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        const makeInput = $('#make-input');
        const makesInput = $('#id_makes');
        const makesDisplay = $('#makes-display');
        const addMakeBtn = $('#add-make');

        // Initialize makes from the form field
        let makes = makesInput.val() ? makesInput.val().split(',').map(m => m.trim()) : [];
        updateMakesDisplay();

        // Add make when button clicked or Enter pressed
        addMakeBtn.click(addMake);
        makeInput.keypress(function(e) {
            if (e.which == 13) {
                e.preventDefault();
                addMake();
            }
        });

        function addMake() {
            const make = makeInput.val().trim();
            if (make && !makes.includes(make)) {
                makes.push(make);
                updateMakesDisplay();
                updateMakesInput();
                makeInput.val('');
            }
        }

        function removeMake(make) {
            makes = makes.filter(m => m !== make);
            updateMakesDisplay();
            updateMakesInput();
        }

        function updateMakesDisplay() {
            makesDisplay.empty();
            makes.forEach(make => {
                const tag = $('<span>', {
                    class: 'make-tag',
                    html: make + '<span class="remove-make">&times;</span>'
                });
                tag.find('.remove-make').click(() => removeMake(make));
                makesDisplay.append(tag);
            });
        }

        function updateMakesInput() {
            makesInput.val(makes.join(', '));
        }
    });
</script>
{% endblock %}