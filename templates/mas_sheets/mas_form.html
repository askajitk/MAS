{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ mas|yesno:"Edit,Create" }} MAS | {{ block.super }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2>{{ mas|yesno:"Edit,Create" }} MAS</h2>
                </div>
                <div class="card-body">
                    {% if is_revision %}
                    <div class="alert alert-info" role="alert">
                        You are submitting a new revision for <strong>{{ mas.mas_id }}</strong>. Only the latest revision can be submitted. Previous revisions are view-only and listed below.
                    </div>
                    {% endif %}
                    <form method="post" enctype="multipart/form-data" id="masForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            {{ form.project|as_crispy_field }}
                        </div>
                        
                        <div class="form-group">
                            {{ form.building|as_crispy_field }}
                        </div>
                        
                        <div class="form-group">
                            {{ form.service|as_crispy_field }}
                        </div>
                        
                        <div class="form-group">
                            {{ form.item|as_crispy_field }}
                        </div>
                        
                        <div class="form-group">
                            {{ form.make_choices|as_crispy_field }}
                        </div>
                        
                        <div class="form-group" id="otherMakeGroup" style="display: none;">
                            {{ form.other_make|as_crispy_field }}
                        </div>
                        
                        <div class="form-group">
                            {{ form.attachment|as_crispy_field }}
                        </div>
                        
                        <button type="submit" class="btn btn-primary">{% if is_revision %}Submit Revision{% else %}Save{% endif %}</button>
                        <a href="{% url 'mas_sheets:mas_list' %}" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
            {% if is_revision and revision_history %}
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="h5 mb-0">Revision History</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>Revision</th>
                                    <th>Status</th>
                                    <th>Updated</th>
                                    <th>Attachment</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rev in revision_history %}
                                <tr {% if rev.is_latest %}class="table-primary"{% endif %}>
                                    <td>
                                        <strong>{{ rev.revision }}</strong>
                                        {% if rev.is_latest %}
                                            <span class="badge bg-primary ms-1">Current</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if rev.status == 'pending_review' %}
                                            <span class="badge bg-warning">Pending Review</span>
                                        {% elif rev.status == 'pending_approval' %}
                                            <span class="badge bg-info">Pending Approval</span>
                                        {% elif rev.status == 'approved' %}
                                            <span class="badge bg-success">Approved</span>
                                        {% elif rev.status == 'rejected' %}
                                            <span class="badge bg-danger">Rejected</span>
                                        {% elif rev.status == 'revision_requested' %}
                                            <span class="badge bg-warning">Revision Requested</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rev.updated_at|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if rev.attachment %}
                                            <a href="{{ rev.attachment.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize Select2 on all select fields for searchable dropdowns
        $('#id_project').select2({
            placeholder: 'Select a project',
            allowClear: true
        });
        
        $('#id_building').select2({
            placeholder: 'Select a building',
            allowClear: true
        });
        
        $('#id_service').select2({
            placeholder: 'Select a service',
            allowClear: true
        });
        
        $('#id_item').select2({
            placeholder: 'Select an item',
            allowClear: true
        });
        
        $('#id_make_choices').select2({
            placeholder: 'Select a make',
            allowClear: true
        });
        
        // Project change handler
        $("#id_project").change(function() {
            var projectId = $(this).val();
            if (projectId) {
                // Load buildings
                $.ajax({
                    url: "{% url 'mas_sheets:ajax_load_buildings' %}",
                    data: { 'project': projectId },
                    success: function(data) {
                        $("#id_building").html('<option value="">---------</option>');
                        data.forEach(function(item) {
                            $("#id_building").append(
                                $('<option></option>').val(item.id).html(item.name)
                            );
                        });
                        $('#id_building').trigger('change.select2'); // Notify Select2 of changes
                    }
                });
                
                // Load services
                $.ajax({
                    url: "{% url 'mas_sheets:ajax_load_services' %}",
                    data: { 'project': projectId },
                    success: function(data) {
                        $("#id_service").html('<option value="">---------</option>');
                        data.forEach(function(item) {
                            $("#id_service").append(
                                $('<option></option>').val(item.id).html(item.name)
                            );
                        });
                        $('#id_service').trigger('change.select2'); // Notify Select2 of changes
                    }
                });
                
                // Clear dependent fields
                $("#id_item").html('<option value="">---------</option>');
                $('#id_item').trigger('change.select2');
                $("#id_make_choices").html('<option value="">---------</option>');
                $('#id_make_choices').trigger('change.select2');
            }
        });
        
        // Service change handler
        $("#id_service").change(function() {
            var serviceId = $(this).val();
            if (serviceId) {
                var ajaxData = { 'service': serviceId, 'project': $("#id_project").val() };
                {% if is_revision and mas %}
                ajaxData['revision_mas_id'] = '{{ mas.mas_id }}';
                {% endif %}
                $.ajax({
                    url: "{% url 'mas_sheets:ajax_load_items' %}",
                    data: ajaxData,
                    success: function(data) {
                        $("#id_item").html('<option value="">---------</option>');
                        data.forEach(function(item) {
                            $("#id_item").append(
                                $('<option></option>').val(item.id).html(item.name)
                            );
                        });
                        $('#id_item').trigger('change.select2'); // Notify Select2 of changes
                    }
                });
                // Clear make choices
                $("#id_make_choices").html('<option value="">---------</option>');
                $('#id_make_choices').trigger('change.select2');
            }
        });
        
        // Item change handler
        $("#id_item").change(function() {
            var itemId = $(this).val();
            if (itemId) {
                $.ajax({
                    url: "{% url 'mas_sheets:ajax_load_makes' %}",
                    data: { 'item': itemId },
                    success: function(data) {
                        $("#id_make_choices").html('<option value="">---------</option>');
                        data.forEach(function(item) {
                            $("#id_make_choices").append(
                                $('<option></option>').val(item.id).html(item.name)
                            );
                        });
                        $('#id_make_choices').trigger('change.select2'); // Notify Select2 of changes
                    }
                });
            } else {
                // Clear make choices if no item selected
                $("#id_make_choices").html('<option value="">---------</option>');
                $('#id_make_choices').trigger('change.select2');
            }
        });
        
        // Make choices change handler
        $("#id_make_choices").change(function() {
            if ($(this).val() === 'other') {
                $("#otherMakeGroup").show();
            } else {
                $("#otherMakeGroup").hide();
                $("#id_other_make").val('');
            }
        });
        
        // Show other make field if it was previously selected
        if ($("#id_make_choices").val() === 'other') {
            $("#otherMakeGroup").show();
        }
        
        // Trigger change events for pre-selected values on page load
        // This handles the case where service is pre-selected for vendors
        // Check if service has a value but items dropdown is empty
        var serviceVal = $("#id_service").val();
        if (serviceVal && $("#id_item option").length <= 1) {
            // Service is selected but items not loaded, trigger load
            $("#id_service").trigger('change');
        }
        
        // If in revision mode, make fields read-only but allow form submission
        {% if is_revision %}
        $('#id_project, #id_building, #id_service, #id_item').on('select2:opening', function(e) {
            e.preventDefault();
            return false;
        });
        $('#id_project, #id_building, #id_service, #id_item').css({
            'pointer-events': 'none',
            'background-color': '#e9ecef'
        });
        // Also prevent changes before Select2 initializes
        $('#id_project, #id_building, #id_service, #id_item').prop('readonly', true);
        {% endif %}
    });
</script>
{% endblock %}