{% extends 'base.html' %}

{% block title %}MAS History | {{ block.super }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>MAS Activity History</h2>
    
    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="date_from" class="form-label">Date From</label>
                        <input type="date" class="form-control" name="date_from" id="date_from" value="{{ filters.date_from }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="date_to" class="form-label">Date To</label>
                        <input type="date" class="form-control" name="date_to" id="date_to" value="{{ filters.date_to }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="mas_id" class="form-label">MAS ID</label>
                        <input type="text" class="form-control" name="mas_id" id="mas_id" value="{{ filters.mas_id }}" placeholder="Search MAS ID">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="action" class="form-label">Action</label>
                        <select class="form-control" name="action" id="action">
                            <option value="">All Actions</option>
                            {% for action_val, action_label in actions %}
                                <option value="{{ action_val }}" {% if filters.action == action_val %}selected{% endif %}>{{ action_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="created_by" class="form-label">Created By</label>
                        <select class="form-control" name="created_by" id="created_by">
                            <option value="">All Users</option>
                            {% for user in users %}
                                <option value="{{ user.id }}" {% if filters.created_by == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="reviewed_by" class="form-label">Reviewed By</label>
                        <select class="form-control" name="reviewed_by" id="reviewed_by">
                            <option value="">All Reviewers</option>
                            {% for user in users %}
                                <option value="{{ user.id }}" {% if filters.reviewed_by == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="approved_by" class="form-label">Approved By</label>
                        <select class="form-control" name="approved_by" id="approved_by">
                            <option value="">All Approvers</option>
                            {% for user in users %}
                                <option value="{{ user.id }}" {% if filters.approved_by == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="project" class="form-label">Project</label>
                        <select class="form-control" name="project" id="project">
                            <option value="">All Projects</option>
                            {% for proj in projects %}
                                <option value="{{ proj.id }}" {% if filters.project == proj.id|stringformat:"s" %}selected{% endif %}>{{ proj.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="building" class="form-label">Building</label>
                        <select class="form-control" name="building" id="building">
                            <option value="">All Buildings</option>
                            {% for bldg in buildings %}
                                <option value="{{ bldg.id }}" {% if filters.building == bldg.id|stringformat:"s" %}selected{% endif %}>{{ bldg.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="service" class="form-label">Service</label>
                        <select class="form-control" name="service" id="service">
                            <option value="">All Services</option>
                            {% for serv in services %}
                                <option value="{{ serv.id }}" {% if filters.service == serv.id|stringformat:"s" %}selected{% endif %}>{{ serv.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="item" class="form-label">Item</label>
                        <select class="form-control" name="item" id="item">
                            <option value="">All Items</option>
                            {% for itm in items %}
                                <option value="{{ itm.id }}" {% if filters.item == itm.id|stringformat:"s" %}selected{% endif %}>{{ itm.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="make" class="form-label">Make</label>
                        <select class="form-control" name="make" id="make">
                            <option value="">All Makes</option>
                            {% for mk in makes %}
                                <option value="{{ mk }}" {% if filters.make == mk %}selected{% endif %}>{{ mk }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="{% url 'mas_sheets:mas_history' %}" class="btn btn-secondary">Clear Filters</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Activity Logs (Showing latest 500 records)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>MAS ID</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Project</th>
                            <th>Building</th>
                            <th>Service</th>
                            <th>Item</th>
                            <th>Make</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
                            <td>{{ log.mas.mas_id }}</td>
                            <td>
                                {% if log.action == 'created' %}
                                    <span class="badge bg-primary">{{ log.get_action_display }}</span>
                                {% elif log.action == 'edited' %}
                                    <span class="badge bg-info">{{ log.get_action_display }}</span>
                                {% elif log.action == 'reviewed' or log.action == 'submitted_approval' %}
                                    <span class="badge bg-warning">{{ log.get_action_display }}</span>
                                {% elif log.action == 'approved' %}
                                    <span class="badge bg-success">{{ log.get_action_display }}</span>
                                {% elif log.action == 'rejected' %}
                                    <span class="badge bg-danger">{{ log.get_action_display }}</span>
                                {% elif log.action == 'revision_requested' %}
                                    <span class="badge bg-warning">{{ log.get_action_display }}</span>
                                {% elif log.action == 'revision_submitted' %}
                                    <span class="badge bg-info">{{ log.get_action_display }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ log.get_action_display }}</span>
                                {% endif %}
                            </td>
                            <td>{{ log.user.username|default:"System" }}</td>
                            <td>{{ log.project_name }}</td>
                            <td>{{ log.building_name }}</td>
                            <td>{{ log.service_name }}</td>
                            <td>{{ log.item_name }}</td>
                            <td>{{ log.make }}</td>
                            <td>
                                {% if log.status == 'pending_review' %}
                                    <span class="badge bg-warning">Pending Review</span>
                                {% elif log.status == 'pending_approval' %}
                                    <span class="badge bg-info">Pending Approval</span>
                                {% elif log.status == 'approved' %}
                                    <span class="badge bg-success">Approved</span>
                                {% elif log.status == 'rejected' %}
                                    <span class="badge bg-danger">Rejected</span>
                                {% elif log.status == 'revision_requested' %}
                                    <span class="badge bg-warning">Revision Requested</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ log.details|truncatewords:15 }}</small>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No activity logs found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
